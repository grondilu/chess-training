<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chess Openings Training</title>

    <link rel="stylesheet" type="text/css" href="assets/chessground.base.css" />
    <link rel="stylesheet" type="text/css" href="assets/chessground.brown.css" />
    <link rel="stylesheet" type="text/css" href="assets/chessground.cburnett.css" />
    <style>
      /*
      body {
        display: flex;
        flex-wrap: wrap;
      }
      */

      body > div {
        margin: 10px;
      }

      .chessground {
        width: 600px;
        height: 600px;
      }

      cg-board {
        background-color: #bfcfdd;
      }
    </style>

    <script type="module">
      import { Chessground } from './node_modules/chessground/dist/chessground.js';
      import { Chess, SQUARES  } from './node_modules/chess.js/dist/esm/chess.js';
      import { repertoire  } from './repertoire.js';
      import { book        } from './opening-book.js';
      import { SRS         } from './spaced-repetition.js';

      const toDests = (chess) => {
	let dests = new Map();
	SQUARES.forEach((s) => {
	  const ms = chess.moves({ square: s, verbose: true });
	  if (ms.length) dests.set(s, ms.map((m) => m.to));
	});
	return dests;
      };

      // https://stackoverflow.com/questions/951021/what-is-the-javascript-version-of-sleep
      function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

      if (typeof localStorage == 'undefined') {
	alert("web storage is not supported");
	throw "no web storage";
      }

      const DEBUG = true;
      const storage = DEBUG ? sessionStorage : localStorage;
      function log(msg) { if (DEBUG) console.log(msg); }

      function pack(line)   { return `${line.compacted_moves}/${line.color}`; }
      function unpack(line) {
	let split = line.split('/');
	return { compacted_moves: split[0], color: split[1] }
      }

      var lines = [];
      for (let color of ['white', 'black'])
	for (let compacted_moves of repertoire[color]) {
	  let line = { compacted_moves, color };
	  lines.push(line);
	}
      var srs = new SRS(storage, lines.map(pack));


      const halfMoveRegex = /(?:O-O(?:-O)?|[KQBNR](?:[a-h]|[1-8]|[a-h][1-8])??x?[a-h][1-8]|(?:[a-h]x)?[a-h][1-8](?:=[QBNR])?)\+?!?/g;

      function identifyOpening(compacted_moves) {
	return book
	  .filter(x => compacted_moves.substr(0, x[2].length) == x[2])
	  // https://chatgpt.com/share/6790de81-57fc-8001-bd96-65afd0006857
	  .reduce((min, item) => min[2].length < item[2].length ? item : min)[1]
      }
      /* Test identifyOpening
	var line = repertoire.white[35];
	log(line);
	log(identifyOpening(line));
      */

      function quiz(line) {
	let chess = new Chess(),
	    color = line.color,
	    moves = line.compacted_moves.match(halfMoveRegex),
	    board = Chessground(document.getElementById('chessboard'), {});
	if (color == 'black') {
	  // make first move
	  if (moves.length > 0) {
	    let move = chess.move(moves.shift());
	    board.move(move.from, move.to);
	    //document.getElementById('soundMove').play();
	  }
	}

	board.set(
	  {
	      orientation: color,
	      selectable: { enable: true },
	      movable: {
		free: false,
		dests: toDests(chess),
		//showDests: true,
		events: {
		  after: async (from, to, metadata) => {
		    document.getElementById('soundMove').play();
		    if (moves.length > 0) {
		      try {
			let move = chess.move({ from, to }),
			expected_move = moves.shift();
			// Is the user's move the expected one?
			if (move.san == expected_move) {
			  log("good move");
			  //   - shift moves
			  //   - make next half-move if defined
			  if (moves.length > 0) {
			    let nextmove = chess.move(moves.shift());
			    await sleep(500);
			    board.move(nextmove.from, nextmove.to);
			    board.set({ movable: { dests: toDests(chess) } });
			    document.getElementById('soundMove').play();
			  }
			  if (moves.length == 0) {
			    document.getElementById('soundSuccess').play();
			    log("success! stopping board");
			    srs.pass(pack(line));
			    board.stop();
			  }
			} else {
			  document.getElementById('soundWrong').play();
			  log(`wrong move: ${expected_move} was expected`);
			  chess.undo();
			  await sleep(1000);
			  board.set({ fen: chess.fen() });
			  let move = chess.move(expected_move);
			  board.move(move.from, move.to);
			  board.stop();
			  srs.fail(pack(line));
			  //alert(`wrong move! ${expected_move} was expected.`);
			}
		      }
		      catch (err) {
			board.set({ fen: chess.fen() });
			console.warn(err);
		      }
		    } else { console.warn("unexpected user input, stopping board"); board.stop(); }
		  }
		}
	      }
	    }
	);
	log(line);
	document.getElementById("info").innerHTML = identifyOpening(line.compacted_moves);

      }

      /*
      document.addEventListener(
	'keydown',
	e => {
	  const keyName = e.key;
	  if (keyName === 'f') {
	    orientation = orientation == 'white' ? 'black' : 'white';
	    quiz();
	  }
	}
      );
      */

      /*
      for (let sanmove of line.match(halfMoveRegex)) {
	let move = chess.move(sanmove);
	if (!move) throw "illegal move";
	board.move(move.from, move.to);
      }
      */

      function quiznewline() {
	let line = srs.pick();
	log(line);
	if (typeof(line) == 'undefined') {
	  throw "undefined line??";
	} else { quiz(unpack(line)); }
      }

      document.getElementById("thebutton").onclick =
	() => {
	  console.clear();
	  quiznewline();
	  let stats = srs.stats;
	  document.getElementById('stats').innerHTML = Array.from(stats.values()).join('/');
	};

      quiznewline();


    </script>
  </head>
  <body>
    <audio id=soundMove    src=assets/sounds/move.wav      type="audio/wav"></audio>
    <audio id=soundTake    src=assets/sounds/take.wav      type="audio/wav"></audio>
    <audio id=soundCheck   src=assets/sounds/check.wav     type="audio/wav"></audio>
    <audio id=soundWrong   src=assets/sounds/wrong.wav     type="audio/wav"></audio>
    <audio id=soundSuccess src=assets/sounds/success.wav   type="audio/wav"></audio>

    <div class="chessground" id="chessboard"></div>
    <br><button type=button id=thebutton>pick line</button>
    <p id="info"></p>
    <p id="stats"></p>
  </body>
</html>
<!--
	vi: shiftwidth=2 nu
-->
